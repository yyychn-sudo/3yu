name: RustDesk Config Check

on:
  workflow_dispatch:
    inputs:
      relay_server:
        description: 'Custom Relay Server'
        required: false
        default: ''
      rs_pub_key:
        description: 'Custom RSA Public Key'
        required: false
        default: ''
      custom_api_url:
        description: 'Custom API URL'
        required: false
        default: ''

env:
  RELAY_SERVER: ${{ github.event.inputs.relay_server || vars.RELAY_SERVER || '' }}
  RS_PUB_KEY: ${{ github.event.inputs.rs_pub_key || vars.RS_PUB_KEY || '' }}
  CUSTOM_API_URL: ${{ github.event.inputs.custom_api_url || vars.CUSTOM_API_URL || '' }}

jobs:
  check-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: æ£€æŸ¥é…ç½®ç¯å¢ƒå’Œæ–‡ä»¶
      run: |
        echo "=== RustDesk é…ç½®æ£€æŸ¥ ==="
        echo ""
        
        # 1. ç¯å¢ƒå˜é‡æ£€æŸ¥
        echo "ğŸ“‹ ç¯å¢ƒå˜é‡çŠ¶æ€:"
        echo "------------------"
        echo "RELAY_SERVER:    $(if [ -n "$RELAY_SERVER" ]; then echo "âœ… å·²è®¾ç½® (${#RELAY_SERVER} å­—ç¬¦)"; else echo "âŒ æœªè®¾ç½®"; fi)"
        echo "RS_PUB_KEY:      $(if [ -n "$RS_PUB_KEY" ]; then echo "âœ… å·²è®¾ç½® (${#RS_PUB_KEY} å­—ç¬¦)"; else echo "âŒ æœªè®¾ç½®"; fi)"
        echo "CUSTOM_API_URL:  $(if [ -n "$CUSTOM_API_URL" ]; then echo "âœ… å·²è®¾ç½® (${#CUSTOM_API_URL} å­—ç¬¦)"; else echo "âŒ æœªè®¾ç½®"; fi)"
        echo ""
        
        # 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "ğŸ“ æ–‡ä»¶æ£€æŸ¥:"
        echo "------------------"
        
        CONFIG_RS_PATH="libs/hbb_common/src/config.rs"
        COMMON_RS_PATH="src/common.rs"
        
        if [ -f "$CONFIG_RS_PATH" ]; then
          echo "âœ… $CONFIG_RS_PATH å­˜åœ¨"
          echo "   æ–‡ä»¶å¤§å°: $(wc -c < "$CONFIG_RS_PATH") å­—èŠ‚"
        else
          echo "âŒ $CONFIG_RS_PATH ä¸å­˜åœ¨"
          echo "   å°è¯•æŸ¥æ‰¾ç±»ä¼¼æ–‡ä»¶:"
          find . -name "config.rs" -type f 2>/dev/null | head -5 | while read file; do
            echo "   - $file"
          done
        fi
        
        if [ -f "$COMMON_RS_PATH" ]; then
          echo "âœ… $COMMON_RS_PATH å­˜åœ¨"
          echo "   æ–‡ä»¶å¤§å°: $(wc -c < "$COMMON_RS_PATH") å­—èŠ‚"
        else
          echo "âŒ $COMMON_RS_PATH ä¸å­˜åœ¨"
          echo "   å°è¯•æŸ¥æ‰¾ç±»ä¼¼æ–‡ä»¶:"
          find . -name "common.rs" -type f 2>/dev/null | head -5 | while read file; do
            echo "   - $file"
          done
        fi
        echo ""
        
        # 3. æ£€æŸ¥ç›®æ ‡å­—ç¬¦ä¸²
        echo "ğŸ” ç›®æ ‡å­—ç¬¦ä¸²æ£€æŸ¥:"
        echo "------------------"
        
        if [ -f "$CONFIG_RS_PATH" ]; then
          echo "æ£€æŸ¥ $CONFIG_RS_PATH:"
          
          # æ£€æŸ¥ä¸­ç»§æœåŠ¡å™¨
          if grep -q "rs-ny\.rustdesk\.com" "$CONFIG_RS_PATH"; then
            echo "   âœ… æ‰¾åˆ° 'rs-ny.rustdesk.com'"
            grep -n "rs-ny\.rustdesk\.com" "$CONFIG_RS_PATH" | head -3 | while read line; do
              echo "      ç¬¬ $line"
            done
          else
            echo "   âŒ æœªæ‰¾åˆ° 'rs-ny.rustdesk.com'"
            echo "      æœç´¢å…¶ä»– rustdesk åŸŸå:"
            grep -n "rustdesk\.com" "$CONFIG_RS_PATH" | head -3 || echo "      æ— å…¶ä»– rustdesk åŸŸå"
          fi
          
          # æ£€æŸ¥ RSA å…¬é’¥
          KEY_PATTERN="OeVuKk5nlHiXp+APNn0Y3pC1Iwpwn44JGqrQCsWqmBw="
          if grep -q "$KEY_PATTERN" "$CONFIG_RS_PATH"; then
            echo "   âœ… æ‰¾åˆ° RSA å…¬é’¥"
            grep -n "$KEY_PATTERN" "$CONFIG_RS_PATH" | while read line; do
              echo "      ç¬¬ $line"
            done
          else
            echo "   âŒ æœªæ‰¾åˆ° RSA å…¬é’¥"
            echo "      æœç´¢ 'OeVu' å¼€å¤´çš„å†…å®¹:"
            grep -n "OeVu" "$CONFIG_RS_PATH" || echo "      æ—  OeVu å¼€å¤´çš„å†…å®¹"
          fi
        fi
        
        if [ -f "$COMMON_RS_PATH" ]; then
          echo "æ£€æŸ¥ $COMMON_RS_PATH:"
          
          # æ£€æŸ¥ API URL
          if grep -q "admin\.rustdesk\.com" "$COMMON_RS_PATH"; then
            echo "   âœ… æ‰¾åˆ° 'admin.rustdesk.com'"
            grep -n "admin\.rustdesk\.com" "$COMMON_RS_PATH" | head -3 | while read line; do
              echo "      ç¬¬ $line"
            done
          else
            echo "   âŒ æœªæ‰¾åˆ° 'admin.rustdesk.com'"
            echo "      æœç´¢ 'rustdesk.com':"
            grep -n "rustdesk\.com" "$COMMON_RS_PATH" | head -3 || echo "      æ—  rustdesk.com ç›¸å…³å†…å®¹"
          fi
        fi
        echo ""
        
        # 4. ç¼–ç æ£€æŸ¥
        echo "ğŸ”¤ æ–‡ä»¶ç¼–ç æ£€æŸ¥:"
        echo "------------------"
        
        if [ -f "$CONFIG_RS_PATH" ]; then
          echo "æ£€æŸ¥ $CONFIG_RS_PATH ç¼–ç :"
          if command -v file &> /dev/null; then
            file -i "$CONFIG_RS_PATH" 2>/dev/null || echo "   æ— æ³•æ£€æµ‹ç¼–ç "
          else
            echo "   'file' å‘½ä»¤ä¸å¯ç”¨"
          fi
          
          # ç®€å• UTF-8 æ£€æŸ¥
          echo -n "   UTF-8 å¯è¯»æ€§: "
          if head -c 100 "$CONFIG_RS_PATH" | grep -q -v '[^[:print:][:space:]]'; then
            echo "âœ… çœ‹èµ·æ¥æ˜¯æ–‡æœ¬æ–‡ä»¶"
          else
            echo "âš ï¸  å¯èƒ½åŒ…å«éæ–‡æœ¬å­—ç¬¦"
          fi
        fi
        echo ""
        
        # 5. åˆ›å»ºæµ‹è¯•æ›¿æ¢è„šæœ¬
        echo "ğŸ§ª åˆ›å»ºæµ‹è¯•æ›¿æ¢è„šæœ¬:"
        echo "------------------"
        
        cat > /tmp/test_replace.py << 'EOF'
#!/usr/bin/env python3
import os, sys

print("Python æµ‹è¯•è„šæœ¬")
print("=" * 40)

# æ£€æŸ¥æ–‡ä»¶
files = {
    'config.rs': 'libs/hbb_common/src/config.rs',
    'common.rs': 'src/common.rs'
}

for name, path in files.items():
    if os.path.exists(path):
        print(f"\nâœ… {name} å­˜åœ¨: {path}")
        try:
            # äºŒè¿›åˆ¶è¯»å–æµ‹è¯•
            with open(path, 'rb') as f:
                data = f.read(500)
            print(f"   å¯ä»¥äºŒè¿›åˆ¶è¯»å– ({len(data)} å­—èŠ‚)")
            
            # å°è¯•æŸ¥æ‰¾å…³é”®å­—ç¬¦ä¸²
            targets = {
                'ä¸­ç»§æœåŠ¡å™¨': b'rs-ny.rustdesk.com',
                'RSAå…¬é’¥': b'OeVuKk5nlHiXp+APNn0Y3pC1Iwpwn44JGqrQCsWqmBw=',
                'APIåœ°å€': b'admin.rustdesk.com'
            }
            
            for desc, target in targets.items():
                if target in data:
                    pos = data.find(target)
                    print(f"   æ‰¾åˆ° {desc} åœ¨ä½ç½® {pos}")
                else:
                    print(f"   âŒ æœªæ‰¾åˆ° {desc}")
                    
        except Exception as e:
            print(f"   è¯»å–é”™è¯¯: {e}")
    else:
        print(f"\nâŒ {name} ä¸å­˜åœ¨: {path}")

print("\n" + "=" * 40)
print("æµ‹è¯•å®Œæˆ!")
EOF
        
        python3 /tmp/test_replace.py
        echo ""
        
        # 6. æ€»ç»“å’Œå»ºè®®
        echo "ğŸ“ æ€»ç»“å’Œå»ºè®®:"
        echo "------------------"
        
        if [ ! -f "$CONFIG_RS_PATH" ] || [ ! -f "$COMMON_RS_PATH" ]; then
          echo "âŒ é—®é¢˜: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯"
          echo "   å»ºè®®: æ£€æŸ¥é¡¹ç›®ç»“æ„ï¼Œç¡®è®¤æ–‡ä»¶ä½ç½®"
        elif ([ -n "$RELAY_SERVER" ] || [ -n "$RS_PUB_KEY" ]) && ! grep -q "rs-ny\.rustdesk\.com" "$CONFIG_RS_PATH" 2>/dev/null; then
          echo "âŒ é—®é¢˜: é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡å­—ç¬¦ä¸²"
          echo "   å»ºè®®: æ£€æŸ¥ RustDesk ç‰ˆæœ¬ï¼Œå­—ç¬¦ä¸²å¯èƒ½å·²æ›´æ”¹"
        elif [ -n "$CUSTOM_API_URL" ] && ! grep -q "admin\.rustdesk\.com" "$COMMON_RS_PATH" 2>/dev/null; then
          echo "âŒ é—®é¢˜: API é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡å­—ç¬¦ä¸²"
          echo "   å»ºè®®: æ£€æŸ¥æ–‡ä»¶å†…å®¹å’Œæœç´¢å­—ç¬¦ä¸²"
        else
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡!"
          echo "   å¯ä»¥æ­£å¸¸æ‰§è¡Œé…ç½®æ›¿æ¢"
          
          # æ˜¾ç¤ºæ›¿æ¢å‘½ä»¤ç¤ºä¾‹
          echo ""
          echo "ğŸ’¡ æ‰‹åŠ¨æ›¿æ¢å‘½ä»¤ç¤ºä¾‹:"
          if [ -n "$RELAY_SERVER" ]; then
            echo "   sed -i 's/rs-ny\\.rustdesk\\.com/$RELAY_SERVER/g' $CONFIG_RS_PATH"
          fi
          if [ -n "$RS_PUB_KEY" ]; then
            echo "   sed -i 's/OeVuKk5nlHiXp+APNn0Y3pC1Iwpwn44JGqrQCsWqmBw=/$RS_PUB_KEY/g' $CONFIG_RS_PATH"
          fi
          if [ -n "$CUSTOM_API_URL" ]; then
            echo "   sed -i 's/admin\\.rustdesk\\.com/$CUSTOM_API_URL/g' $COMMON_RS_PATH"
          fi
        fi
